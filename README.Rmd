---
output: github_document
---

# UC Berkeley Forest Analytics

The `UCBForestAnalytics` package is a suite of open-source R functions designed to produce standard metrics for forest management and ecology from field inventory data. 


## Installation instructions

To install the `UCBForestAnalytics` package from GitHub:

```r
# install and load devtools
install.packages("devtools")
library(devtools)
```

```r
# install and load Rbiomass
devtools::install_github('kearutherford/UCBForestAnalytics')
library(UCBForestAnalytics)
```


## Biomass estimations 

The biomass functions (`TreeBiomass` and `SummaryBiomass`) use Forest Inventory and Analysis (FIA) Regional Biomass Equations to estimate above-ground stem, bark, and branch tree biomass. The functions use the California equation set and should not be used for data from other regions. See references 1 & 2 below. 


### :eight_spoked_asterisk: `TreeBiomass ( )`

### Inputs

1. `data` A dataframe or tibble. Each row must be an observation of an individual tree.

2. `status` Must be a variable (column) in the provided dataframe or tibble. Specifies whether the individual tree is alive (1) or dead (0). The class of this variable will be coerced to factor.

3. `species` Must be a variable (column) in the provided dataframe or tibble. Specifies the species of the individual tree. Must follow four-letter species code or FIA naming conventions (see species code tables below). The class of this variable will be coerced to character.

4. `dbh` Must be a **numeric** variable (column) in the provided dataframe or tibble. Provides the diameter at breast height (DBH) of the individual tree in either centimeters or inches. 

5. `ht` Must be a **numeric** variable (column) in the provided dataframe or tibble. Provides the height of the individual tree in either meters or feet.

6. `sp_codes` Not a variable (column) in the provided dataframe or tibble. Specifies whether the species variable follows the four-letter code or FIA naming convention (see species code tables below). Must be set to either "4letter" or "fia". The default is set to "4letter".

7. `units` Not a variable (column) in the provided dataframe or tibble. Specifies whether the dbh and ht variables were measured using metric (centimeters and meters) or imperial (inches and feet) units. Also specifies whether the results will be given in metric (kilograms) or imperial (US tons) units. Must be set to either "metric" or "imperial". The default is set to "metric".

### Outputs

The original dataframe will be returned, with four new columns:

1. `stem_bio_kg` (or `stem_bio_tons`): biomass of stem in kilograms (or US tons)

2. `bark_bio_kg` (or `bark_bio_tons`): biomass of bark in kilograms (or US tons)

3. `branch_bio_kg` (or `branch_bio_tons`): biomass of branches in kilograms (or US tons)

4. `total_bio_kg` (or `total_bio_kg`): biomass of tree (stem + bark + branches) in kilograms (or US tons)

*Important note: For some hardwood species, the `stem_bio` includes bark and branch biomass. In these cases, bark and branch biomass are not available as separate components of total biomass. `bark_bio` and `branch_bio` will appear as `NA` and the `total_bio` will be equivalent to the `stem_bio`.*

### Demonstration

```{r, include = FALSE}
library(UCBForestAnalytics)
```

```{r}
# investigate input dataframe
demo_data
```

```{r}
# call the TreeBiomass() function in the UCBForestAnalytics package
tree_bio_demo <- TreeBiomass(data = demo_data,
                             status = "Live",
                             species = "SPP",
                             dbh = "DBH_CM",
                             ht = "HT_M",
                             sp_codes = "4letter",
                             units = "metric")

tree_bio_demo
```

**Notice in the output dataframe:**

* QUKE (California black oak) has `NA` `bark_bio_kg` and `branch_bio_kg`. For some hardwood species, the `stem_bio_kg` includes bark and branch biomass. In these cases, bark and branch biomass are not available as separate components of total biomass. 

* The column names of the input dataframe will remain intact in the output dataframe.

* The `Forest`, `Plot_id`, and `SPH` columns, which are not directly used in the biomass calculations, remain in the output dataframe. Any additional columns in the input dataframe will remain in the output dataframe.

<br>

### :eight_spoked_asterisk: `SummaryBiomass( )`

### Inputs

1. `data` A dataframe or tibble. Each row must be an observation of an individual tree.

2. `site` Must be a variable (column) in the provided dataframe or tibble. Describes the broader location or forest where the data were collected. The class of this variable will be coerced to character.

3. `plot` Must be a variable (column) in the provided dataframe or tibble. Identifies the plot in which the individual tree was measured. The class of this variable will be coerced to character.

4. `exp_factor` Must be a numeric variable (column) in the provided dataframe or tibble. The expansion factor specifies the number of trees per hectare (or per acre) that a given plot tree represents.

5. `status` Must be a variable (column) in the provided dataframe or tibble. Specifies whether the individual tree is alive (1) or dead (0). The class of this variable will be coerced to factor.

6. `species` Must be a variable (column) in the provided dataframe or tibble. Specifies the species of the individual tree. Must follow four-letter species code or FIA naming conventions (see species code tables below). The class of this variable will be coerced to character.

7. `dbh` Must be a **numeric** variable (column) in the provided dataframe or tibble. Provides the diameter at breast height (DBH) of the individual tree in either centimeters or inches. 

8. `ht` Must be a **numeric** variable (column) in the provided dataframe or tibble. Provides the height of the individual tree in either meters or feet.

9. `sp_codes` Not a variable (column) in the provided dataframe or tibble. Specifies whether the species variable follows the four-letter code or FIA naming convention (see species code tables below). Must be set to either "4letter" or "fia". The default is set to "4letter".

10. `units` Not a variable (column) in the provided dataframe or tibble. Specifies (1) whether the dbh and ht variables were measured using metric (centimeters and meters) or imperial (inches and feet) units; (2) whether the expansion factor is in metric (stems per hectare) or imperial (stems per acre) units; and (3) whether results will be given in metric (megagrams per hectare) or imperial (US tons per acre) units. Must be set to either "metric" or "imperial". The default is set to "metric".

11. `results` Not a variable (column) in the provided dataframe or tibble. Specifies whether the results will be summarized by plot or by plot as well as species. Must be set to either "by_plot" or "by_species." The default is set to "by_plot".

### Outputs

A dataframe with the following columns: 

1. `site`: as described above

2. `plot`: as described above

3. `species`: if results argument was set to "by_species"

4. `live_Mg_ha` (or `live_ton_ac`): above-ground live tree biomass in megagrams per hectare (or US tons per acre)

5. `dead_Mg_ha` (or `dead_ton_ac`): above-ground dead tree biomass in megagrams per hectare (or US tons per acre)

### Demonstrations 

```{r}
# investigate input dataframe
demo_data
```

<br>

**Results summarized by plot:**
```{r}
# call the SummaryBiomass() function in the UCBForestAnalytics package
# keep default sp_codes (= "4letter") and units (= "metric")
sum_bio_demo1 <- SummaryBiomass(data = demo_data,
                                site = "Forest",
                                plot = "Plot_id",
                                exp_factor = "SPH",
                                status = "Live",
                                species = "SPP",
                                dbh = "DBH_CM",
                                ht = "HT_M",
                                results = "by_plot")

sum_bio_demo1
```

<br>

**Results summarized by plot as well as by species:**
```{r}
# call the SummaryBiomass() function in the UCBForestAnalytics package
# keep default sp_codes (= "4letter") and units (= "metric")
sum_bio_demo2 <- SummaryBiomass(data = demo_data,
                                site = "Forest",
                                plot = "Plot_id",
                                exp_factor = "SPH",
                                status = "Live",
                                species = "SPP",
                                dbh = "DBH_CM",
                                ht = "HT_M",
                                results = "by_species")

sum_bio_demo2
```

<br>

## Forest composition and structure compilations  

The forest composition and structure functions (`ForestComp` and `ForestStr`) assist with common plot-level data compilations. These functions help ensure that best practices in data compilation are observed.


### :eight_spoked_asterisk: `ForestComp( )`

### Inputs

1. `data` A dataframe or tibble. Each row must be an observation of an individual tree.

2. `site` Must be a variable (column) in the provided dataframe or tibble. Describes the broader location or forest where the data were collected. The class of this variable will be coerced to character.

3. `plot` Must be a variable (column) in the provided dataframe or tibble. Identifies the plot in which the individual tree was measured. The class of this variable will be coerced to character.

4. `exp_factor` Must be a numeric variable (column) in the provided dataframe or tibble. The expansion factor specifies the number of trees per hectare (or per acre) that a given plot tree represents.

5. `status` Must be a variable (column) in the provided dataframe or tibble. Specifies whether the individual tree is alive (1) or dead (0). The class of this variable will be coerced to factor.

6. `species` Must be a variable (column) in the provided dataframe or tibble. Specifies the species of the individual tree. The class of this variable will be coerced to character.

7. `dbh` Must be a numeric variable (column) in the provided dataframe or tibble. Provides the diameter at breast height (DBH) of the individual tree in either centimeters or inches.

8. `relative` Not a variable (column) in the provided dataframe or tibble. Specifies whether forest composition should be measured as relative basal area or relative density. Must be set to either "BA" or "density". The default is set to "BA".

9. `units` Not a variable (column) in the provided dataframe or tibble. Specifies whether the dbh variable was measured using metric (centimeters) or imperial (inches) units. Must be set to either "metric" or "imperial". The default is set to "metric".

### Outputs

A dataframe with the following columns: 

1. `site`: as described above

2. `plot`: as described above

3. `species`: as described above 

4. `dominance`: relative basal area (or relative density) in percent (%). Only compiled for LIVE trees. 

### Demonstrations

```{r}
# investigate input dataframe
demo_comp_data
```

<br>

**Composition measured as relative basal area:**
```{r}
# call the ForestComp() function in the UCBForestAnalystics package
# keep default relative (= "BA") and units (= "metric")
comp_demo <- ForestComp(data = demo_comp_data,
                        site = "Forest",
                        plot = "Plot_id",
                        exp_factor = "SPH",
                        status = "Live",
                        species = "SPP",
                        dbh = "DBH_CM")

comp_demo
```

<br>

**Composition measured as relative density:**
```{r}
# call the ForestComp() function in the UCBForestAnalystics package
comp_demo2 <- ForestComp(data = demo_comp_data,
                         site = "Forest",
                         plot = "Plot_id",
                         exp_factor = "SPH",
                         status = "Live",
                         species = "SPP",
                         dbh = "DBH_CM",
                         relative = "density",
                         units = "metric")

comp_demo2
```

<br>

### :eight_spoked_asterisk: `ForestStr( )`

### Inputs

1. `data` A dataframe or tibble. Each row must be an observation of an individual tree.

2. `site` Must be a variable (column) in the provided dataframe or tibble. Describes the broader location or forest where the data were collected. The class of this variable will be coerced to character.

3. `plot` Must be a variable (column) in the provided dataframe or tibble. Identifies the plot in which the individual tree was measured. The class of this variable will be coerced to character.

4. `exp_factor` Must be a numeric variable (column) in the provided dataframe or tibble. The expansion factor specifies the number of trees per hectare (or per acre) that a given plot tree represents.

5. `dbh` Must be a numeric variable (column) in the provided dataframe or tibble. Provides the diameter at breast height (DBH) of the individual tree in either centimeters or inches.

6. `ht` Default is set to "ignore", which indicates that tree heights were not taken. If heights were taken, it can be set to a numeric variable (column) in the provided dataframe or tibble, providing the height of the individual tree in either meters or feet.

7. `units` Not a variable (column) in the provided dataframe or tibble. Specifies (1) whether the dbh and ht variables were measured using metric (centimeters and meters) or imperial (inches and feet) units; (2) whether the expansion factor is in metric (stems per hectare) or imperial (stems per acre) units; and (3) whether results will be given in metric or imperial units. Must be set to either "metric" or "imperial". The default is set to "metric".

### Outputs

A dataframe with the following columns: 

1. `site`: as described above

2. `plot`: as described above

3. `sph` (or `spa`): stems per hectare (or stems per acre)

4. `ba_m2_ha` (or `ba_ft2_ac`): basal area in meters squared per hectare (or feet squared per acre)

5. `qmd_cm` (or `qmd_in`): quadratic mean diameter in centimeters (or inches). Weighted by the expansion factor.

6. `dbh_cm` (or `dbh_in`): diameter at breast hegiht in centimeters (or inches). Weighted by the expansion factor.

7. `ht_m` (or `ht_ft`): average height in meters (or feet) if ht argument was set. Weighted by the expansion factor.

### Demonstrations

```{r}
# investigate input dataframe
demo_comp_data
```

<br>

**If tree heights were not measured:**
```{r}
# call the ForestStr() function in the UCBForestAnalystics package
# keep default ht (= "ignore") and units (= "metric")
str_demo <- ForestStr(data = demo_comp_data,
                      site = "Forest",
                      plot = "Plot_id",
                      exp_factor = "SPH",
                      dbh = "DBH_CM")

str_demo
```

<br>

**If tree heights were measured:**
```{r}
# call the ForestStr() function in the UCBForestAnalystics package
str_demo2 <- ForestStr(data = demo_comp_data,
                       site = "Forest",
                       plot = "Plot_id",
                       exp_factor = "SPH",
                       dbh = "DBH_CM",
                       ht = "HT_M",
                       units = "metric")

str_demo2
```

<br>

## Background information 

### Species code tables

**Softwoods**

|common name|scientific name|4-letter code|FIA code|
|:---|:---|:---|:---|
|White fir|Abies concolor|ABCO|15|
|Grand fir|Abies grandis|ABGR|17|
|California red fir|Abies magnifica|ABMA|20|
|Noble fir|Abies procera|ABPR|22|
|Western juniper|Juniperus occidentalis|JUOC|64|
|Incense cedar|Calocedrus decurrens|CADE|81|
|Lodgepole pine|Pinus contorta|PICO|108|
|Jeffrey pine|Pinus jeffreyi|PIJE|116|
|Sugar pine|Pinus lambertinana|PILA|117|
|Western white pine|Pinus monticola|PIMO|119|
|Ponderosa pine|Pinus ponderosa|PIPO|122|
|Foothill pine|Pinus sabiniana|PISA|127|
|Douglas-fir|Pseudotsuga menziesii|PSME|202|
|Redwood|Sequoioideae sempervirens|SESE|211|
|Giant sequoia|Sequoiadendron giganteum|SEGI|212|
|Pacific yew|Taxus brevifolia|TABR|231|
|California nutmeg|Torreya californica|TOCA|251|
|Western hemlock|Tsuga heterophylla|TSHE|263|
|Mountain hemlock|Tsuga mertensiana|TSME|264|
|Unknown conifer|NA|UNCO|298|

<br>

**Hardwoods** 

|common name|scientific name|4-letter code|FIA code|
|:---|:---|:---|:---|
|Bigleaf maple|Acer macrophyllum|ACMA|312|
|White alder|Alnus rhombifolia|ALRH|352|
|Pacific madrone|Arbutus menziesii|ARME|361|
|Golden chinkapin|Chrysolepis chrysophylla|CHCH|431|
|Pacific dogwood|Cornus nuttallii|CONU|492|
|Tanoak|Notholithocarpus densiflorus|NODE|631|
|Quaking aspen|Populus tremuloides|POTR|746|
|California live oak|Quercus agrifolia|QUAG|801|
|Canyon live oak|Quercus chrysolepis|QUCH|805|
|California black oak|Quercus kelloggii|QUKE|818|
|Willow species|Salix spp.|SASP|920|
|California-laurel|Umbellularia californica|UMCA|981|
|Unknown hardwood|NA|UNHA|998|
|Unknown tree|NA|UNTR|999|

*Note: Four-letter species codes are the first two letters of the genus followed by the first two letters of the species.*


## References 

1. *Volume Estimation for the PNW-FIA Integrated Database.* U.S. Department of Agriculture, Forest Service, Pacific Northwest Research Station. [Link to PDF](https://ww2.arb.ca.gov/sites/default/files/cap-and-trade/protocols/usforest/2014/volume_equations.pdf)


2. *Regional Biomass Equations Used by FIA to Estimate Bole, Bark, and Branches.* U.S. Department of Agriculture, Forest Service, Pacific Northwest Research Station. [Link to PDF](https://ww2.arb.ca.gov/sites/default/files/cap-and-trade/protocols/usforest/2014/biomass_equations.pdf) 

